\documentclass[11pt,a4paper]{article}

% === PACKAGES ===
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{libertinus}
\usepackage[margin=2.5cm]{geometry}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage{tabularray}
\usepackage{booktabs}
\usepackage{fontawesome5}
\usepackage{hyperref}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{listings}

% === COLOR DEFINITIONS ===
\definecolor{ClothoBlack}{HTML}{1a1a2e}
\definecolor{ClothoGray}{HTML}{4a4a6a}
\definecolor{ClothoLight}{HTML}{f0f0f5}
\definecolor{PassGreen}{HTML}{2d6a4f}
\definecolor{FailRed}{HTML}{9d0208}
\definecolor{WarnAmber}{HTML}{e85d04}
\definecolor{CodeBg}{HTML}{f8f9fa}

% === TCOLORBOX STYLES ===
\tcbuselibrary{skins,breakable}

\newtcolorbox{evidencebox}[1][]{
    enhanced,
    breakable,
    colback=CodeBg,
    colframe=ClothoGray,
    boxrule=0.5pt,
    arc=2pt,
    left=8pt,
    right=8pt,
    top=6pt,
    bottom=6pt,
    fonttitle=\bfseries\ttfamily\small,
    #1
}

\newtcolorbox{passbox}{
    enhanced,
    colback=PassGreen!5,
    colframe=PassGreen,
    boxrule=1pt,
    arc=3pt,
    left=10pt,
    fontupper=\bfseries,
    before upper={\faCheckCircle\hspace{8pt}}
}

\newtcolorbox{failbox}{
    enhanced,
    colback=FailRed!5,
    colframe=FailRed,
    boxrule=1pt,
    arc=3pt,
    left=10pt,
    fontupper=\bfseries,
    before upper={\faTimesCircle\hspace{8pt}}
}

\newtcolorbox{summarybox}[1][]{
    enhanced,
    colback=ClothoLight,
    colframe=ClothoBlack,
    boxrule=1pt,
    arc=4pt,
    left=12pt,
    right=12pt,
    top=10pt,
    bottom=10pt,
    fonttitle=\bfseries\large,
    #1
}

% === LISTINGS CONFIG ===
\lstset{
    basicstyle=\ttfamily\footnotesize,
    backgroundcolor=\color{CodeBg},
    breaklines=true,
    frame=none,
    numbers=none,
    xleftmargin=0pt,
    xrightmargin=0pt
}

% === HEADER/FOOTER ===
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\fancyhead[L]{\textsc{Clotho Audit Report}}
\fancyhead[R]{\textsc{\VAR{standard|latex_escape}}}
\fancyfoot[L]{\small Generated: \VAR{generated_at}}
\fancyfoot[R]{\small Page \thepage\ of \pageref{LastPage}}

% === HYPERREF CONFIG ===
\hypersetup{
    colorlinks=true,
    linkcolor=ClothoBlack,
    urlcolor=ClothoGray,
    pdfauthor={Clotho Engine},
    pdftitle={ISO 27002:2022 Compliance Audit Report}
}

% === DOCUMENT ===
\begin{document}

% === TITLE PAGE ===
\begin{titlepage}
    \centering
    \vspace*{3cm}
    
    {\Huge\bfseries\textsc{Compliance Audit Report}}
    
    \vspace{0.5cm}
    {\Large\textcolor{ClothoGray}{\VAR{standard|latex_escape}}}
    
    \vspace{2cm}
    
    \begin{tcolorbox}[
        enhanced,
        width=0.7\textwidth,
        colback=ClothoLight,
        colframe=ClothoBlack,
        arc=5pt,
        boxrule=1.5pt,
        halign=center
    ]
        {\large\bfseries Organization}\\[4pt]
        {\Large \VAR{organization|latex_escape}}
    \end{tcolorbox}
    
    \vspace{1.5cm}
    
    \begin{tabular}{rl}
        \textbf{Generated:} & \VAR{generated_at} \\[4pt]
        \textbf{Nodes Audited:} & \VAR{report.nodes|join(', ')|latex_escape} \\[4pt]
        \textbf{Baseline Version:} & \VAR{report.baseline_version|latex_escape}
    \end{tabular}
    
    \vfill
    
    \BLOCK{ if summary.entropy_detected }
    \begin{failbox}
        ENTROPY DETECTED --- System has drifted from baseline
    \end{failbox}
    \BLOCK{ else }
    \begin{passbox}
        ORDERED STATE CONFIRMED --- No drift detected
    \end{passbox}
    \BLOCK{ endif }
    
    \vspace{2cm}
    
    {\small\textcolor{ClothoGray}{\textit{Generated by Clotho Engine v1.0}}}
    
\end{titlepage}

% === EXECUTIVE SUMMARY ===
\section*{Executive Summary}

\begin{summarybox}[title=Audit Results Overview]
    \begin{center}
    \begin{tblr}{
        colspec={X[c]X[c]X[c]X[c]},
        row{1}={font=\bfseries},
        hlines={ClothoGray, 0.5pt},
        vlines={ClothoGray, 0.3pt},
        cell{1}{1-4}={bg=ClothoLight}
    }
        Total Checks & Passed & Failed & Pass Rate \\
        \VAR{summary.total_checks} & 
        \textcolor{PassGreen}{\VAR{summary.passed}} & 
        \textcolor{FailRed}{\VAR{summary.failed}} & 
        \VAR{"%.1f"|format(summary.pass_rate)}\%
    \end{tblr}
    \end{center}
\end{summarybox}

\vspace{1em}

\subsection*{Control Summary Matrix}

\begin{center}
\begin{tblr}{
    colspec={lXcc},
    row{1}={font=\bfseries, bg=ClothoBlack, fg=white},
    hlines={ClothoGray, 0.5pt},
    column{1}={font=\ttfamily},
    cell{2-Z}{3}={fg=PassGreen},
    cell{2-Z}{4}={fg=FailRed}
}
    Control ID & Control Title & Passed & Failed \\
\BLOCK{ for ctrl_id, ctrl in summary.by_control.items() }
    \VAR{ctrl_id|latex_escape} & \VAR{ctrl.title|latex_escape} & \VAR{ctrl.passed} & \VAR{ctrl.failed} \\
\BLOCK{ endfor }
\end{tblr}
\end{center}

\newpage

% === DETAILED FINDINGS ===
\section*{Detailed Findings}

\BLOCK{ for finding in findings }
\subsection*{[\VAR{finding.control_id|latex_escape}] \VAR{finding.control_title|latex_escape}}

\begin{tabular}{@{}ll@{}}
    \textbf{Node:} & \texttt{\VAR{finding.node|latex_escape}} \\
    \textbf{Collector:} & \texttt{\VAR{finding.collector_type|latex_escape}} \\
    \textbf{Timestamp:} & \VAR{finding.timestamp|latex_escape}
\end{tabular}

\vspace{0.5em}

\BLOCK{ if finding.passed }
\begin{passbox}
    PASS --- Control requirements satisfied
\end{passbox}
\BLOCK{ else }
\begin{failbox}
    FAIL --- Delta entropy detected
\end{failbox}
\BLOCK{ endif }

\vspace{0.5em}

\begin{evidencebox}[title=Command Executed]
\begin{lstlisting}
\VAR{finding.command}
\end{lstlisting}
\end{evidencebox}

\BLOCK{ if finding.evidence.get('forbidden_found') }
\begin{evidencebox}[title=Forbidden Items Detected, colframe=FailRed]
\begin{itemize}[leftmargin=*, nosep]
\BLOCK{ for item in finding.evidence.forbidden_found }
    \item \texttt{\VAR{item|latex_escape}}
\BLOCK{ endfor }
\end{itemize}
\end{evidencebox}
\BLOCK{ endif }

\BLOCK{ if finding.evidence.get('unexpected') }
\begin{evidencebox}[title=Unexpected Items (Not in Baseline), colframe=WarnAmber]
\begin{itemize}[leftmargin=*, nosep]
\BLOCK{ for item in finding.evidence.unexpected }
    \item \texttt{\VAR{item|latex_escape}}
\BLOCK{ endfor }
\end{itemize}
\end{evidencebox}
\BLOCK{ endif }

\BLOCK{ if finding.evidence.get('mismatches') }
\begin{evidencebox}[title=Hash Mismatches (Configuration Drift), colframe=FailRed]
\begin{tblr}{
    colspec={lXX},
    row{1}={font=\bfseries\small, bg=FailRed!10},
    hlines={ClothoGray, 0.3pt},
    column{1}={font=\ttfamily\small}
}
    Path & Expected & Actual \\
\BLOCK{ for m in finding.evidence.mismatches }
    \VAR{m.path|latex_escape} & \texttt{\VAR{m.expected[:16]|latex_escape}...} & \texttt{\VAR{m.actual[:16]|latex_escape}...} \\
\BLOCK{ endfor }
\end{tblr}
\end{evidencebox}
\BLOCK{ endif }

\BLOCK{ if finding.evidence.get('allowed_found') }
\begin{evidencebox}[title=Allowed Items Found, colframe=PassGreen]
\begin{itemize}[leftmargin=*, nosep]
\BLOCK{ for item in finding.evidence.allowed_found }
    \item \texttt{\VAR{item|latex_escape}}
\BLOCK{ endfor }
\end{itemize}
\end{evidencebox}
\BLOCK{ endif }

\vspace{1em}
\hrule
\vspace{1em}

\BLOCK{ endfor }

% === APPENDIX: RAW EVIDENCE ===
\newpage
\section*{Appendix: Raw Evidence}

\small
\BLOCK{ for finding in findings }
\subsection*{[\VAR{finding.control_id|latex_escape}] \VAR{finding.collector_type|latex_escape} @ \VAR{finding.node|latex_escape}}

\begin{evidencebox}[title=Raw Output]
\begin{lstlisting}
\VAR{finding.raw_output[:2000]}
\end{lstlisting}
\end{evidencebox}

\BLOCK{ endfor }

\end{document}
